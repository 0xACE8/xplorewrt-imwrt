#
# Copyright (c) 2019-2026 0xACE8
#
# æœ¬ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ãƒ•ãƒªãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã§ã‚ã‚Šã€MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
# è©³ç´°ã«ã¤ã„ã¦ã¯ /LICENSE ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
#
# https://github.com/0xACE8
#
# èª¬æ˜: GitHub Actionsã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã‚’æ´»ç”¨ã—ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã—ãŸOpenWrtãƒ“ãƒ«ãƒ‰ã€‚
#

name: Build redmi_ax6000_512mb xplorewrt dl24.10 snapshot kernel 6.6.95 actions.

on:
  workflow_dispatch:
    inputs:
      restore_config:
        description: 'Restore Configuration. ğŸ‡¯ğŸ‡µ è¨­å®šã‚’å¾©å…ƒ'
        type: boolean
        default: false
      boost_wifi_5g:
        description: 'Boost Wi-Fi 5G Signal. ğŸ‡¯ğŸ‡µ 5Gä¿¡å·ã®å¢—å¹…'
        type: boolean
        default: false
      upload_firmware:
        description: 'Upload FW to Artifact. ğŸ‡¯ğŸ‡µ Artifactã«ä¿å­˜'
        type: boolean
        default: false
      upload_release:
        description: 'Upload FW to Release.. ğŸ‡¯ğŸ‡µ Releaseã«å…¬é–‹'
        type: boolean
        default: false
      upload_wenshushu:
        description: 'Upload FW to WENSHUSHU ğŸ‡¯ğŸ‡µ æ–‡å”å”ã«è»¢é€'
        type: boolean
        default: false  
      telegram_notify:
        description: 'Telegram Notification. ğŸ‡¯ğŸ‡µ Telegramé€šçŸ¥'
        type: boolean
        default: true
      keepalive_cache:
        description: 'Manual Cache Keepalive ğŸ‡¯ğŸ‡µ ä¿æ´»ãƒ¢ãƒ¼ãƒ‰'
        type: boolean
        default: false
      clean_cache:
        description: 'Clean all old CACHE... ğŸ‡¯ğŸ‡µ CACHEã‚’å‰Šé™¤'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 2 * * 0'     # æ¯å‘¨æ—¥ 02:00 è¿è¡Œ (ä¿æŒç¼“å­˜æ´»è·ƒï¼Œé˜²æ­¢è¢« GitHub åˆ é™¤)
    - cron: '0 0 1 * *'     # æ¯æœˆ 1 å· 00:00 è¿è¡Œ (ç”±äº Key åŒ…å«æœˆä»½ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå…¨æ–°ç¼“å­˜)
    
env:
  # annawrt 2410
  REPO_DLOOK2410_K66_LINK:                    ${{ secrets.REPO_DLOOK2410_K66_LINK }}
  REPO_DLOOK2410_K66_TREE:                    ${{ secrets.REPO_DLOOK2410_K66_TREE }}
  REPO_DLOOK2410_K66_HEAD:                    ${{ secrets.REPO_DLOOK2410_K66_HEAD }}
  REPO_DLOOK2410_K66_DIFF:                    ${{ secrets.REPO_DLOOK2410_K66_DIFF }}
  # cmcc-xr30-emmc
  REDMI_AX6000_512MB_DLOOK2410_K66_PATCHES:   ${{ secrets.REDMI_AX6000_512MB_DLOOK2410_K66_PATCHES }}
  REDMI_AX6000_512MB_DLOOK2410_K66_PROFILE:   ${{ secrets.REDMI_AX6000_512MB_DLOOK2410_K66_PROFILE }}
  REDMI_AX6000_512MB_DLOOK2410_K66_ARCHIVE:   ${{ secrets.REDMI_AX6000_512MB_DLOOK2410_K66_ARCHIVE }}
  # token
  GITHUB_TOKEN:                               ${{ secrets.ACCESS_TOKEN }}
  ACCESS_TOKEN:                               ${{ secrets.ACCESS_TOKEN }}
  # feeds source & check sha512sum
  ADD_EXTRA_SOURCE:                           ${{ secrets.ADD_EXTRA_SOURCE }}
  ACCESS_SHA512SUM:                           ${{ secrets.ACCESS_SHA512SUM }}
  ACCESS_REPACKAGE:                           ${{ secrets.ACCESS_REPACKAGE }}
  # luci & packages repo
  REPO_PLUGIN_SLUG:                           ${{ secrets.REPO_PLUGIN_SLUG }}
  REPO_PLUGIN_HEAD:                           ${{ secrets.REPO_PLUGIN_HEAD }}
  REPO_PLUGIN_FLOW:                           ${{ secrets.REPO_PLUGIN_FLOW }}
  # cmcc color sytle for argon
  ARGON_THEME_XIAOMI:                         ${{ secrets.ARGON_THEME_XIAOMI }}
  # telegram bot
  TELEGRAM_BOT_KEY:                           ${{ secrets.TELEGRAM_BOT_KEY }}
  TELEGRAM_CHAT_ID:                           ${{ secrets.TELEGRAM_CHAT_ID }}
  # input status
  INPUT_RESTORE:                              ${{ github.event.inputs.restore_config }}
  INPUT_BOOST5G:                              ${{ github.event.inputs.boost_wifi_5g }}
  INPUT_ARTIFACT:                             ${{ github.event.inputs.upload_firmware }}
  INPUT_RELEASE:                              ${{ github.event.inputs.upload_release }}
  INPUT_WENSHUSHU:                            ${{ github.event.inputs.upload_wenshushu }}
  INPUT_NOTIFY:                               ${{ github.event.inputs.telegram_notify }}
  INPUT_KEEPALIVE:                            ${{ github.event_name == 'schedule' || github.event.inputs.keepalive_cache == 'true' }}
  INPUT_CLEANCACHE:                           ${{ github.event.inputs.clean_cache }}
  # hardware & repo info
  DEVICE_NAME:                                REDMI_AX6000
  TARGET_CHIP:                                mt7986a
  TARGET_DISK:                                SPI_NAND_512MB
  SOURCE_CODE:                                dailook
  KERNEL_VERS:                                kernel_6.6.95
  OUTPUT_FILE:                                xplorewrt-dl24.10-k6.6-mt7986a-redmi_ax6000-512mb-sysupgrade
  TZ: "Asia/Tokyo"

jobs:
  build:
    runs-on: ubuntu-22.04

    permissions: write-all

    steps:
    - name: Start Timer (è¨ˆæ¸¬é–‹å§‹)
      run: |
        echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

    - name: Sync and Wait for Plugin Repo (ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã®åŒæœŸã¨å¾…æ©Ÿ)
      run: |
        LAST_TS=$(date -d $(gh run list -w "$REPO_PLUGIN_FLOW" -R "$REPO_PLUGIN_SLUG" -s success --limit 1 --json updatedAt -q '.[0].updatedAt // "1970-01-01"') +%s)
        DIFF=$(( ($(date +%s) - LAST_TS) / 3600 ))
        if [ "$DIFF" -ge 24 ]; then
          echo "âš ï¸ æœ€çµ‚åŒæœŸã‹ã‚‰ ${DIFF}æ™‚é–“çµŒéã€‚åŒæœŸã‚’é–‹å§‹ã—ã¾ã™..."
          gh workflow run "$REPO_PLUGIN_FLOW" -R "$REPO_PLUGIN_SLUG" -r "$REPO_PLUGIN_HEAD"
          for i in {1..30}; do
            sleep 20
            RUN_ID=$(gh run list -w "$REPO_PLUGIN_FLOW" -R "$REPO_PLUGIN_SLUG" --limit 1 --json databaseId,status -q 'map(select(.status != "completed")) | .[0].databaseId')
            [[ -n "$RUN_ID" && "$RUN_ID" != "null" ]] && break
          done
          [[ -z "$RUN_ID" ]] && echo "âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸ" && exit 1
          gh run watch "$RUN_ID" -R "$REPO_PLUGIN_SLUG" --exit-status
        else
          echo "âœ… æœ€è¿‘åŒæœŸã•ã‚Œã¾ã—ãŸï¼ˆ${DIFF}æ™‚é–“å‰ï¼‰ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
        fi

    - name: Checkout (ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ)
      uses: actions/checkout@main
      with:
        fetch-depth: 0

    - name: Check Server Performance (ã‚µãƒ¼ãƒãƒ¼æ€§èƒ½ã®ç¢ºèª)
      run: |
        echo "âš ï¸æ³¨æ„âš ï¸"
        echo "ã‚µãƒ¼ãƒãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹ã¯æœ‰é™ã§ã™ã€‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®éå‰°ãªé¸æŠã¯CPUé«˜è² è·ã®åŸå› ã¨ãªã‚Šã¾ã™ã€‚"
        echo -e "æ—¢çŸ¥ã®CPUãƒ¢ãƒ‡ãƒ«ï¼ˆé™é †ï¼‰: 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
        echo "-------------------------CPU æƒ…å ±---------------------------"
        echo "CPUã®ç‰©ç†æ•°  : $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUã‚³ã‚¢æ•°    : $(nproc)"
        echo -e "CPUãƒ¢ãƒ‡ãƒ«æƒ…å ±:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
        echo "------------------------ãƒ¡ãƒ¢ãƒªæƒ…å ±--------------------------"
        echo "ãƒ¡ãƒ¢ãƒªã®è©³ç´°:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
        echo "---------------------ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±---------------------"
        echo "ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT

    - name: Initialize Environment (ç’°å¢ƒã®åˆæœŸåŒ–)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt -yqq update
        sudo -E apt -yqq install zip rename dos2unix libfuse-dev python3-netifaces libcrypt-dev libncurses5-dev
        sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo timedatectl set-timezone "$TZ"
        sudo chown $USER:$GROUPS $GITHUB_WORKSPACE
        git config --global url."https://$ACCESS_TOKEN@github.com/0xACE8/".insteadOf "https://github.com/0xACE8/"
        git config --global core.compression 0

    - name: Clone Source Code (ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚¯ãƒ­ãƒ¼ãƒ³)
      working-directory: ./
      run: |
        df -hT $PWD
        git clone --depth 1 $REPO_DLOOK2410_K66_LINK -b $REPO_DLOOK2410_K66_HEAD openwrt
        # Remove China Mirrors (ä¸­å›½å›½å†…ãƒŸãƒ©ãƒ¼ã®å‰Šé™¤)
        [ -f "openwrt/scripts/projectsmirrors.json" ] && sed -i '/.cn\//d; /tencent/d; /aliyun/d' openwrt/scripts/projectsmirrors.json && rm -rf files
        # Prepare Cache Key (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®å‡†å¤‡)
        mkdir -p ${{ github.workspace }}/openwrt/.ccache
        echo "CACHE_MONTH=$(date +%Y%m)" >> $GITHUB_ENV
        [[ "$INPUT_CLEANCACHE" == "true" ]] && echo "CLEAN_MARK=_clean_$(date +%s)" >> $GITHUB_ENV || echo "CLEAN_MARK=" >> $GITHUB_ENV

    - name: Cache Toolchain (ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
      uses: stupidloud/cachewrtbuild@main
      with:
        ccache: true
        toolchain: true
        skip: true
        mixkey: ${{ env.TARGET_CHIP }}-${{ env.CACHE_MONTH }}-${{ env.SOURCE_CODE }}-${{ secrets.REPO_DLOOK2410_K66_TREE }}-${{ secrets.REPO_DLOOK2410_K66_HEAD }}-${{ env.KERNEL_VERS }}-[${{ env.CLEAN_MARK }}]
        prefix: ${{ github.workspace }}/openwrt

    - name: Cache dl Directory (dlãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
      uses: actions/cache@v3
      with:
        path: openwrt/dl
        key: mt798x-${{ env.CACHE_MONTH }}-${{ env.SOURCE_CODE }}-${{ secrets.REPO_DLOOK2410_K66_TREE }}-${{ secrets.REPO_DLOOK2410_K66_HEAD }}-${{ env.KERNEL_VERS }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          mt798x-${{ env.CACHE_MONTH }}-${{ env.SOURCE_CODE }}-${{ secrets.REPO_DLOOK2410_K66_TREE }}-${{ secrets.REPO_DLOOK2410_K66_HEAD }}-${{ env.KERNEL_VERS }}-

    - name: Update & Install Feeds (ãƒ•ã‚£ãƒ¼ãƒ‰ã®æ›´æ–°ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
      working-directory: ./openwrt
      run: |
        # Surgical Clean Go Cache (Goã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç‰©ç†å‰Šé™¤)
        [ -d "dl/go-mod-cache" ] && rm -rf dl/go-mod-cache && mkdir -p openwrt/dl/go-mod-cache
        ${{ secrets.REDMI_AX6000_512MB_DLOOK2410_K66_PATCHES }}
        ${{ secrets.ADD_EXTRA_SOURCE }}
        ./scripts/feeds update -a
        rm -rf feeds/packages/lang/rust && git clone https://github.com/0xACE8/packages_lang_rust -b 1.90.0 feeds/packages/lang/rust
        rm -rf feeds/packages/lang/golang && git clone https://github.com/sbwml/packages_lang_golang -b 26.x feeds/packages/lang/golang
        ./scripts/feeds install -a

    - name: Boost Wi-Fi 5G Signal (Wi-Fi 5Gä¿¡å·ã®å¢—å¹…)
      if: env.INPUT_BOOST5G == 'true'
      working-directory: ./openwrt
      run: |
        ${{ secrets.BOOST_5G_TO_25DBM }}

    - name: Load Custom Configuration (ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®èª­ã¿è¾¼ã¿)
      working-directory: ./openwrt
      id: loadconfig
      run: |
        set +x
        cat <<'EOF' > .config
        ${{ secrets.REDMI_AX6000_512MB_DLOOK2410_K66_PROFILE }}
        EOF
        ${{ secrets.REPO_DLOOK2410_K66_DIFF }}
        ${{ secrets.ARGON_THEME_XIAOMI }}
        sed -i 's/download-ci-llvm=true/download-ci-llvm=false/g' feeds/packages/lang/rust/Makefile
        cat feeds/packages/lang/rust/Makefile
        # Check CCache Status
        ccache -s

    - name: Restore Config Archive (è¨­å®šã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®å¾©å…ƒ)
      if: steps.loadconfig.outcome == 'success' && env.INPUT_RESTORE == 'true'
      working-directory: ./openwrt
      run: |
        ${{ secrets.REDMI_AX6000_512MB_DLOOK2410_K66_ARCHIVE }}

    - name: Download Packages (ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)
      if: steps.loadconfig.outcome == 'success' && !cancelled()
      working-directory: ./openwrt
      id: package
      run: |
        make defconfig
        make download -j$(nproc)
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Keepalive Cache Refresh (ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã®ãƒãƒ¼ã‚¯ä»˜ã‘)
      if: env.INPUT_KEEPALIVE == 'true'
      run: |
        mkdir -p openwrt/.ccache
        date > openwrt/.ccache/keepalive_timestamp
        echo "âœ… Cache flagged for refresh. Heavy build skipped."

    - name: Compile Firmware (ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«)
      if: env.INPUT_KEEPALIVE != 'true'
      working-directory: ./openwrt
      id: compile
      run: |
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Verify CCache Settings
      if: steps.compile.outcome == 'success'
      run: |
        # Update Variables (å¤‰æ•°ã®æ›´æ–°)
        echo "OUTPUT_FILE=${OUTPUT_FILE}_${FILE_DATE}" >> $GITHUB_ENV
        ccache -p
        ccache -s

    - name: Organize Files (ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†)
      if: steps.compile.outcome == 'success'
      id: organize
      run: |
        cd openwrt/bin/targets/*/*
        FIRMWARE_FILE=$(ls *sysupgrade.* 2>/dev/null | head -n 1)
        EXT="${FIRMWARE_FILE##*.}"
        ls -A | grep -v "$FIRMWARE_FILE" | xargs rm -rdf
        mv "$FIRMWARE_FILE" "${{ env.OUTPUT_FILE }}.$EXT"
        sha512sums ${{ secrets.ACCESS_SHA512SUM }} sha512sums "${{ env.OUTPUT_FILE }}.$EXT"
        ${{ secrets.ACCESS_REPACKAGE }} "${{ env.OUTPUT_FILE }}.$EXT"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload to Artifacts (Artifactã«ä¿å­˜)
      if: steps.organize.outcome == 'success' && env.INPUT_ARTIFACT == 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.OUTPUT_FILE }}
        path: ${{ env.FIRMWARE }}

    - name: Upload to Release (Releaseã«å…¬é–‹)
      if: steps.compile.outcome == 'success' && env.INPUT_RELEASE == 'true'
      uses: softprops/action-gh-release@master
      with:
        token: ${{ secrets.ACCESS_TOKEN }}
        tag_name: ${{ env.FILE_DATE }}_${{ env.TARGET_CHIP }}_${{ env.DEVICE_NAME }}_${{ env.TARGET_DISK }}
        name: ${{ env.TARGET_CHIP }}_${{ env.DEVICE_NAME }}_${{ env.TARGET_DISK }}_${{ env.KERNEL_VERS }}_${{ env.FILE_DATE }}
        files: ${{ env.FIRMWARE }}/*
        body: |
          **æœ¬ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã¯ã€CPUã€Œ${{ env.TARGET_CHIP }}ã€æ­è¼‰ã®ãƒ¢ãƒ‡ãƒ«ã€Œ${{ env.DEVICE_NAME }}ã€âœ… ${{ env.TARGET_DISK }} âœ…å°‚ç”¨ã§ã™ã€‚**
          ### ğŸ“’ã€Œ${{ env.SOURCE_CODE }}ã€ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åŸºã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚
          - ğŸ–¥ï¸ å¯¾å¿œæ©Ÿç¨®: ã€€${{ env.DEVICE_NAME }}
          - ğŸ’¿ å®¹é‡ä»•æ§˜: ã€€${{ env.TARGET_DISK }}
          - ğŸ§ ã‚«ãƒ¼ãƒãƒ«: ã€€${{ env.KERNEL_VERS }}
          - ğŸ‘¤ ã‚½ãƒ¼ã‚¹å: ã€€${{ env.SOURCE_CODE }}
          - ğŸŒ² ã‚½ãƒ¼ã‚¹å…ƒ: ã€€${{ env.REPO_DLOOK2410_K66_TREE }}
          - ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ã€€${{ env.REPO_DLOOK2410_K66_HEAD }}
          - ğŸ”— ç®¡ç†ï¼©ï¼°: ã€€192.168.***.1 ã¾ãŸã¯ ${{ env.SOURCE_CODE }}.lan
          - ğŸ›¡ï¸ åˆæœŸãƒ‘ã‚¹: ã€€********
          ### âš ï¸ å…è²¬äº‹é … âš ï¸
          - â€¼ï¸ **æœ¬ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã¯ã€å€‹äººåˆ©ç”¨ã‚’ç›®çš„ã¨ã—ãŸéå…¬å¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç‰ˆã§ã™ã€‚**
          - â›”ï¸ **å¼·åˆ¶ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç­‰ã§ãƒ‡ãƒã‚¤ã‚¹ãŒç ´æã—ãŸå ´åˆã€æœ¬ãƒªãƒã‚¸ãƒˆãƒªã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚è‡ªå·±è²¬ä»»ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚**

    - name: Upload to wenshushu (ã‚¦ã‚§ãƒ³ãŠã˜ã•ã‚“ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹)
      if: steps.compile.outcome == 'success' && steps.organize.outcome == 'success' && env.INPUT_WENSHUSHU == 'true'
      working-directory: ./openwrt
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wss -s -p 16 -t 600 --no-progress ${FIRMWARE} 2>&1 | tee wenshushu.log
        WENSHUSHU=$(cat wenshushu.log | grep 'Manage Link:' | cut -d' ' -f3-)
        echo "WENSHUSHU=$WENSHUSHU" >> $GITHUB_ENV

    - name: Calculate Duration
      if: always() && env.INPUT_NOTIFY == 'true' && env.INPUT_KEEPALIVE != 'true'
      run: |
        END_TIME=$(date +%s)
        START_TIME=${{ env.START_TIME }}
        TOTAL_SECONDS=$((END_TIME - START_TIME))
        H=$((TOTAL_SECONDS / 3600))
        M=$(((TOTAL_SECONDS % 3600) / 60))
        S=$((TOTAL_SECONDS % 60))
        echo "DURATION=$(printf "%02d:%02d:%02d" $H $M $S)" >> $GITHUB_ENV

    - name: Final Report & TG Notify (ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥)
      if: always() && env.INPUT_NOTIFY == 'true' && env.INPUT_KEEPALIVE != 'true'
      run: |
        get_stat() { [ "$1" == "true" ] && echo "âœ…" || echo "âºï¸"; }
        
        [ "${{ steps.compile.outcome }}" == "success" ] && BUILD_STAT="âœ…ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼âœ…" || BUILD_STAT="âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ âŒ"

        if [[ -n "$WENSHUSHU" ]]; then
            STAT_WEN="âœ…"
            WEN_MSG="â€¢â˜ï¸%20æ–‡æ°è»¢é€:%0Aã€€%20ã€€%20ã€€$WENSHUSHU"
        elif [[ "$INPUT_WENSHUSHU" == "true" ]] || [[ "$GITHUB_EVENT_ACTION" == *"upload_wenshushu"* ]]; then
            STAT_WEN="âŒ (å¤±æ•—)" 
            WEN_MSG=""
        else
            STAT_WEN="âºï¸"
            WEN_MSG=""
        fi
      
        STAT_LIST="â€¢âš™ï¸%20é…ç½®å¤å…ƒ:ã€€%20ã€€%20ã€€$(get_stat "${{ github.event.inputs.restore_config }}")%0A"
        STAT_LIST="${STAT_LIST}â€¢ğŸ›œ%20ä¿¡å·å¢å¹…:ã€€%20ã€€%20ã€€$(get_stat "${{ github.event.inputs.boost_wifi_5g }}")%0A"
        STAT_LIST="${STAT_LIST}â€¢ğŸ’¾%20æ„å»ºæˆæœ:ã€€%20ã€€%20ã€€$(get_stat "${{ github.event.inputs.upload_firmware }}")%0A"
        STAT_LIST="${STAT_LIST}â€¢ğŸš€%20å…¬å¼€é…ä¿¡:ã€€%20ã€€%20ã€€$(get_stat "${{ github.event.inputs.upload_release }}")%0A"
        STAT_LIST="${STAT_LIST}â€¢â˜ï¸%20æ–‡æ°è»¢é€:ã€€%20ã€€%20ã€€${STAT_WEN}%0A"
        STAT_LIST="${STAT_LIST}â€¢ğŸ§¹%20ç¼“å­˜æ¸…ç†:ã€€%20ã€€%20ã€€$(get_stat "${{ github.event.inputs.clean_cache }}")"

        MSG="${BUILD_STAT}"
        MSG="${MSG}%0Aï¼ï¼ï¼ï¼ï¼  åŸº æœ¬ æƒ… å ± ï¼ï¼ï¼ï¼ï¼ï¼"
        MSG="${MSG}%0Aâ€¢ğŸ–¥ï¸%20å¯¾å¿œæ©Ÿç¨®:%0Aã€€%20ã€€%20ã€€${DEVICE_NAME}"
        MSG="${MSG}%0Aâ€¢ğŸ’¿%20å®¹é‡ä»•æ§˜:%0Aã€€%20ã€€%20ã€€${TARGET_DISK}"
        MSG="${MSG}%0Aâ€¢ğŸ§%20ã‚«ãƒ¼ãƒãƒ«:%0Aã€€%20ã€€%20ã€€${KERNEL_VERS}"
        MSG="${MSG}%0Aâ€¢ğŸ‘¤%20ã‚½ãƒ¼ã‚¹å:%0Aã€€%20ã€€%20ã€€${SOURCE_CODE}"
        MSG="${MSG}%0Aâ€¢ğŸŒ²%20ã‚½ãƒ¼ã‚¹å…ƒ:%0Aã€€%20ã€€%20ã€€${REPO_DLOOK2410_K66_TREE}"
        MSG="${MSG}%0Aâ€¢ğŸŒ¿%20ãƒ–ãƒ©ãƒ³ãƒ:%0Aã€€%20ã€€%20ã€€${REPO_DLOOK2410_K66_HEAD}%0A"

        MSG="${MSG}%0Aï¼ï¼ï¼ï¼ï¼ çŠ¶ æ…‹ ä¸€ è¦§ ï¼ï¼ï¼ï¼ï¼ï¼%0A${STAT_LIST}%0A%0A"
        MSG="${MSG}ï¼ï¼ï¼ï¼ï¼ çµ æœ æƒ… å ± ï¼ï¼ï¼ï¼ï¼ï¼%0A"
        MSG="${MSG}â€¢â±ï¸%20å®Ÿè¡Œæ™‚é–“:ã€€%20ã€€%20ã€€${{ env.DURATION }}%0A"
        
        if [ "${{ steps.compile.outcome }}" == "success" ]; then
          MSG="${MSG}â€¢ğŸ“¦%20ãƒ•ã‚¡ã‚¤ãƒ«:%0Aã€€%20ã€€%20ã€€${OUTPUT_FILE}%0A"

          if [[ -n "$WEN_MSG" ]]; then
              MSG="${MSG}%0A${WEN_MSG}"
          fi

        else
          MSG="${MSG}â€¢âŒ%20å¤±æ•—æ™‚åˆ»:ã€€%20ã€€$(date +'%Y-%m-%d %H:%M')%0A"
        fi

        MSG="${MSG}%0Aï¼ï¼ï¼ ï¼ï¼ï¼ ï¼ï¼ï¼ ï¼ï¼ï¼ ï¼ï¼ï¼ "
        
        curl -s -o /dev/null -X GET "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_KEY }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$(echo "$MSG" | sed 's/ /%20/g')"

    - name: Delete Old Workflows (å¤ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‰Šé™¤)
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.ACCESS_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 0
        delete_workflow_pattern: redmi_ax6000_512mb
 
    - name: Delete Old Releases (å¤ã„ãƒªãƒªãƒ¼ã‚¹ã®å‰Šé™¤)
      if: steps.compile.outcome == 'success' && env.INPUT_RELEASE == 'true'
      uses: dev-drprasad/delete-older-releases@master
      with:
        keep_latest: 2
        delete_tags: true
        delete_tag_pattern: "${{ env.TARGET_CHIP }}_${{ env.DEVICE_NAME }}_${{ env.TARGET_DISK }}" 
    
